
import { parse } from 'csv-parse/sync';

const RULES = {
    dailyDrawdown: 250, // 5% of 5000 (Note: Maven is 4%? User said "read the rules in the template". Previous diagnosis for Maven showed 4% daily / 8% max!)
    // Let's re-verify Maven rules from previous diagnosis log.
    // Maven 5k #2 (760314): Rules: DailyDD=4%, MaxDD=8%. Limits: Daily < 200, Max < 400.
    // Maven 5k #1 (756009): Rules: DailyDD=4%, MaxDD=8%. Limits: Daily < 200, Max < 400.

    // BUT EE 5k was 5% / 10%.
    // So for these two accounts, we must use 4% ($200) and 8% ($400).
    mavenDailyLimit: 200,
    mavenMaxLimit: 400,
    accountSize: 5000
};

const CSV_MAVEN_2 = `ID,Symbol,Open Time,Volume,Side,Close Time,Open Price,Close Price,Stop Loss,Take Profit,Swap,Commission,Profit,Reason
W038186827123505,EURUSD,14/07/2025 10:41:32,1.00,SELL,14/07/2025 10:46:01,1.16893,1.16905,1.16914,1.16797,0.00,-4.68,-16.68,User
W036194720823181,US100,14/07/2025 10:35:32,0.20,SELL,14/07/2025 10:40:31,22696.75,22704.95,22704.78,22675.00,0.00,0.00,-32.80,SL
W038186827120079,US100,14/07/2025 09:02:18,0.20,SELL,14/07/2025 09:07:57,22702.00,22710.95,22715.27,22688.26,0.00,0.00,-35.80,User
W038186827117894,US100,14/07/2025 08:11:15,0.20,SELL,14/07/2025 08:50:56,22699.63,22706.45,22706.37,22658.00,0.00,0.00,-27.28,SL
W038186827113462,US100,14/07/2025 06:26:34,0.20,BUY,14/07/2025 06:28:43,22657.08,22658.00,22652.12,22665.02,0.00,0.00,3.68,User
W036194720812689,US100,14/07/2025 06:03:35,0.20,SELL,14/07/2025 06:14:19,22646.25,22645.20,22657.80,22621.25,0.00,0.00,4.20,User
W036194720812504,US100,14/07/2025 05:56:14,0.19,BUY,14/07/2025 06:00:07,22661.32,22650.88,22651.15,22664.01,0.00,0.00,-39.67,SL
W68927104872004056,GBPUSD,11/07/2025 08:16:28,2.00,BUY,11/07/2025 08:22:03,1.35422,1.35387,1.35387,1.35559,0.00,-10.84,-80.84,SL
W68927104872003601,GBPUSD,11/07/2025 08:05:00,1.00,SELL,11/07/2025 08:06:59,1.35369,1.35372,1.35372,1.35229,0.00,-5.42,-8.42,SL
W68967886022004108,GBPUSD,11/07/2025 07:51:44,1.00,BUY,11/07/2025 08:04:45,1.35469,1.35368,1.35368,1.35845,0.00,-5.42,-106.42,SL
W68927104871986258,US100,10/07/2025 17:38:34,0.20,SELL,10/07/2025 17:41:22,22836.58,22841.81,22841.58,22778.55,0.00,0.00,-20.92,SL
W68967886021974429,US100,10/07/2025 13:29:28,0.21,BUY,10/07/2025 13:30:45,22885.48,22885.15,22886.45,22918.64,0.00,0.00,-1.39,SL
W68927104871969106,US100,10/07/2025 12:37:26,0.15,SELL,10/07/2025 12:43:36,22855.78,22855.23,22870.44,22855.59,0.00,0.00,1.65,TP
W68927104871968226,US100,10/07/2025 12:24:16,0.21,SELL,10/07/2025 12:31:10,22862.15,22875.10,22875.07,0.00,0.00,0.00,-54.39,SL
W68967886021955355,GBPUSD,10/07/2025 06:27:27,1.00,SELL,10/07/2025 07:05:30,1.36141,1.36177,1.36175,1.35882,0.00,-5.44,-41.44,SL
W68967886021954740,GBPUSD,10/07/2025 06:11:00,1.00,SELL,10/07/2025 06:15:10,1.36104,1.36149,1.36148,1.35996,0.00,-5.44,-50.44,SL
W68967886021935700,US100,09/07/2025 14:30:01,0.03,SELL,09/07/2025 15:20:25,22851.04,22767.99,22787.65,22664.37,0.00,0.00,49.83,User
W68967886021935700,US100,09/07/2025 14:30:01,0.03,SELL,09/07/2025 15:02:40,22851.04,22767.42,22813.33,22652.30,0.00,0.00,50.17,Partial
W68967886021935700,US100,09/07/2025 14:30:01,0.04,SELL,09/07/2025 15:01:45,22851.04,22764.65,22813.33,22652.30,0.00,0.00,69.11,Partial
W68927104871934540,US100,09/07/2025 14:35:52,0.10,SELL,09/07/2025 14:47:11,22801.52,22800.03,22819.02,22801.02,0.00,0.00,2.98,TP
W68967886021935700,US100,09/07/2025 14:30:01,0.10,SELL,09/07/2025 14:32:25,22851.04,22798.22,22845.96,22737.08,0.00,0.00,105.64,Partial
W68967886021930979,US100,09/07/2025 13:39:37,0.11,BUY,09/07/2025 13:51:51,22856.83,22892.88,22858.20,22922.00,0.00,0.00,79.31,User
W68967886021930979,US100,09/07/2025 13:39:37,0.09,BUY,09/07/2025 13:51:14,22856.83,22897.50,22858.20,22922.00,0.00,0.00,73.21,Partial
M68967886021882658,US100,08/07/2025 12:49:29,0.05,BUY,08/07/2025 13:08:00,22735.33,22759.00,22723.00,22759.00,0.00,0.00,23.67,TP
M68927104871871566,XAUUSD,08/07/2025 09:33:19,0.20,BUY,08/07/2025 09:51:48,3326.39,3321.88,3321.89,3346.00,0.00,0.00,-90.20,SL
M68967886021872261,XAUUSD,08/07/2025 08:48:14,0.10,BUY,08/07/2025 09:30:47,3325.74,3321.73,3321.74,3367.00,0.00,0.00,-40.10,SL
W68967886021841064,XAUUSD,07/07/2025 13:54:22,0.01,BUY,07/07/2025 14:02:21,3317.00,3315.57,3304.00,3319.00,0.00,0.00,-1.43,User
W68967886021839461,US100,07/07/2025 13:39:10,0.20,BUY,07/07/2025 13:40:00,22732.70,22720.25,22721.45,22803.48,0.00,0.00,-49.80,SL
M68967886021830441,XAUUSD,07/07/2025 10:31:36,0.01,SELL,07/07/2025 11:09:08,3307.80,3306.80,3306.80,3292.80,0.00,0.00,1.00,SL
M68967886021830441,XAUUSD,07/07/2025 10:31:36,0.02,SELL,07/07/2025 10:49:37,3307.80,3302.37,3306.12,3287.80,0.00,0.00,10.86,Partial
W68967886021825561,XAUUSD,07/07/2025 08:15:52,0.03,BUY,07/07/2025 09:15:29,3307.77,3309.47,3308.44,3384.00,0.00,0.00,5.10,User
W68967886021825561,XAUUSD,07/07/2025 08:15:52,0.05,BUY,07/07/2025 09:12:01,3307.77,3311.05,3307.97,3384.00,0.00,0.00,16.40,Partial
W68927104871821915,GBPUSD,07/07/2025 07:48:28,1.00,BUY,07/07/2025 08:08:01,1.36073,1.35988,1.35989,1.36571,0.00,-5.44,-90.44,SL
W68967886021824148,GBPUSD,07/07/2025 07:44:04,1.00,BUY,07/07/2025 07:45:55,1.36052,1.36052,1.35989,1.36052,0.00,-5.44,-5.44,TP
W68927104871821581,GBPUSD,07/07/2025 07:41:37,1.00,BUY,07/07/2025 07:43:54,1.36088,1.36028,1.36028,0.00000,0.00,-5.44,-65.44,SL
W68927104871793519,XAUUSD,04/07/2025 10:27:06,0.10,BUY,04/07/2025 10:33:52,3334.87,3334.97,3332.91,3334.97,0.00,0.00,1.00,TP
M68967886021794283,XAUUSD,04/07/2025 09:36:38,0.10,BUY,04/07/2025 10:23:37,3333.72,3333.65,3333.82,3360.00,0.00,0.00,-0.70,SL
W68967886021786155,US100,04/07/2025 05:19:47,0.10,SELL,04/07/2025 05:33:31,22805.62,22803.32,22809.95,22779.17,0.00,0.00,4.60,User
W68927104871782770,US100,04/07/2025 03:57:47,0.20,SELL,04/07/2025 04:53:44,22813.88,22812.08,22819.29,22758.60,0.00,0.00,7.20,User
W68927104871776301,US100,03/07/2025 16:57:45,0.09,SELL,03/07/2025 17:18:41,22863.61,22872.68,22901.20,22653.19,0.00,0.00,-16.33,User
W68927104871767416,US100,03/07/2025 13:44:10,0.05,SELL,03/07/2025 13:51:45,22753.75,22795.82,22781.00,22674.77,0.00,0.00,-42.07,SL`;

const CSV_MAVEN_1 = `ID,Symbol,Open Time,Volume,Side,Close Time,Open Price,Close Price,Stop Loss,Take Profit,Swap,Commission,Profit,Reason
M7679876981902514,US100,18/11/2025 15:04:20,0.20,SELL,18/11/2025 15:06:24,24360.60,24424.37,24432.46,24310.60,0.00,0.00,-255.08,User
W7679876981843974,US100,14/11/2025 16:41:24,0.05,BUY,14/11/2025 16:44:17,25157.35,25105.50,25107.42,25258.89,0.00,0.00,-51.85,SL
W7678563049841660,US100,14/11/2025 16:23:39,0.09,BUY,14/11/2025 16:39:06,25112.70,25142.60,0.00,25165.61,0.00,0.00,53.82,User
W7678563049841660,US100,14/11/2025 16:23:39,0.10,BUY,14/11/2025 16:38:38,25112.70,25149.50,24992.07,25165.61,0.00,0.00,73.60,Partial
M7678563049833961,US100,14/11/2025 12:07:24,0.04,SELL,14/11/2025 13:32:03,24656.91,24614.78,24730.81,24569.37,0.00,0.00,33.70,User
M7678563049812363,US100,13/11/2025 16:05:29,0.19,SELL,13/11/2025 16:06:56,25108.36,25090.85,0.00,25089.60,0.00,0.00,66.54,TP
M7678563049811733,US100,13/11/2025 15:50:29,0.19,SELL,13/11/2025 16:00:18,25114.00,25157.74,0.00,0.00,0.00,0.00,-166.21,User
M7678563049810937,US100,13/11/2025 15:35:26,0.19,SELL,13/11/2025 15:44:35,25212.87,25183.87,0.00,25171.12,0.00,0.00,110.20,User
M7679876981812722,US100,13/11/2025 15:28:28,0.18,SELL,13/11/2025 15:34:49,25263.48,25212.96,0.00,25171.97,0.00,0.00,181.87,User
W7678563049809699,US100,13/11/2025 15:13:19,0.02,BUY,13/11/2025 15:21:20,25337.37,25317.46,25216.43,25611.59,0.00,0.00,-7.96,User
W7678563049807943,US100,13/11/2025 14:44:25,0.03,SELL,13/11/2025 14:53:07,25185.94,25277.02,25276.76,25018.41,0.00,0.00,-54.65,SL
M7678563049777686,US100,12/11/2025 14:56:21,0.07,SELL,12/11/2025 15:00:31,25470.41,25507.35,25507.90,25377.26,0.00,0.00,-51.72,SL
M7679876981724256,US100,10/11/2025 15:00:06,0.09,BUY,10/11/2025 15:50:23,25523.84,25477.96,25481.94,25607.17,0.00,0.00,-82.58,SL
W7678563049659965,US100,06/11/2025 15:00:33,0.02,SELL,06/11/2025 16:43:18,25363.46,25111.47,25416.14,25113.46,0.00,0.00,100.80,TP
W7678563049659965,US100,06/11/2025 15:00:33,0.02,SELL,06/11/2025 16:00:44,25363.46,25191.73,25416.14,25113.46,0.00,0.00,68.69,Partial
W7679876981660403,US100,06/11/2025 14:48:40,0.05,BUY,06/11/2025 14:51:23,25538.90,25455.92,25460.48,25695.40,0.00,0.00,-82.98,SL
M7679876981631469,US100,05/11/2025 14:59:06,0.05,BUY,05/11/2025 15:56:30,25553.51,25556.49,25538.49,25690.33,0.00,0.00,2.98,User
W7678563049628963,US100,05/11/2025 14:39:45,0.03,BUY,05/11/2025 15:56:29,25442.40,25557.46,25360.64,25757.23,0.00,0.00,69.04,User
M7679876981631469,US100,05/11/2025 14:59:06,0.10,BUY,05/11/2025 15:31:11,25553.51,25559.16,25538.49,25669.17,0.00,0.00,11.30,Partial
W7678563049625960,US100,05/11/2025 13:31:28,0.04,BUY,05/11/2025 14:35:06,25434.92,25371.73,25370.74,25622.42,0.00,0.00,-50.55,SL
W7679876981598021,US100,04/11/2025 14:08:37,0.05,SELL,04/11/2025 14:18:16,25557.20,25603.66,25603.60,25460.23,0.00,0.00,-46.46,SL
W7679876981586597,EURUSD,04/11/2025 07:49:09,1.49,BUY,04/11/2025 07:57:01,1.15308,1.15261,1.15268,1.15412,0.00,-6.88,-76.91,SL
M7678563049534366,US500,31/10/2025 14:38:13,0.07,BUY,31/10/2025 15:28:53,6862.1,6855.6,6843.2,6897.2,0.00,-0.96,-23.71,User
M7678563049532956,US500,31/10/2025 14:05:24,0.07,SELL,31/10/2025 14:32:10,6846.1,6860.5,6860.0,6846.1,0.00,-0.96,-51.36,SL`;

interface Trade {
    id: string;
    symbol: string;
    closeTime: string; // DD/MM/YYYY HH:mm:ss
    profit: number;
    commission: number;
    swap: number;
    closeDate: string; // YYYY-MM-DD
}

function parseDate(dateStr: string): string {
    const parts = dateStr.split(' ');
    const dateParts = parts[0].split('/');
    return `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
}

function evaluateAccount(name: string, csvData: string, rules: any) {
    console.log(`\nEvaluating Account: ${name}`);
    console.log(`Rules: Daily Loss < $${rules.mavenDailyLimit}, Max Loss < $${rules.mavenMaxLimit}`);

    try {
        const records = parse(csvData, {
            columns: true,
            skip_empty_lines: true,
            trim: true
        });

        const trades: Trade[] = records.filter((r: any) => r.ID !== 'Total').map((r: any) => ({
            id: r.ID,
            symbol: r.Symbol,
            closeTime: r['Close Time'],
            profit: parseFloat(r.Profit),
            commission: parseFloat(r.Commission),
            swap: parseFloat(r.Swap || '0'),
            closeDate: parseDate(r['Close Time'])
        }));

        trades.sort((a, b) => {
            const parseDT = (dt: string) => {
                const [d, t] = dt.split(' ');
                const [day, month, year] = d.split('/');
                return new Date(`${year}-${month}-${day}T${t}Z`).getTime();
            };
            return parseDT(a.closeTime) - parseDT(b.closeTime);
        });

        console.log(`Loaded ${trades.length} trades.`);

        let currentBalance = rules.accountSize;
        let highWaterMark = rules.accountSize;
        let failed = false;

        const tradesByDay = new Map<string, Trade[]>();
        for (const trade of trades) {
            if (!tradesByDay.has(trade.closeDate)) {
                tradesByDay.set(trade.closeDate, []);
            }
            tradesByDay.get(trade.closeDate)!.push(trade);
        }

        const sortedDays = Array.from(tradesByDay.keys()).sort();
        let runningBalance = rules.accountSize;

        for (const day of sortedDays) {
            const dayTrades = tradesByDay.get(day)!;
            const dayStartBalance = runningBalance;
            let dayPnL = 0;

            for (const trade of dayTrades) {
                const totalTradePnL = trade.profit + trade.commission + trade.swap;
                dayPnL += totalTradePnL;

                const currentBalance = dayStartBalance + dayPnL;
                if (currentBalance > highWaterMark) highWaterMark = currentBalance;

                // Max DD Check (Static: Starting Bal - Limit)
                const maxDDThreshold = rules.accountSize - rules.mavenMaxLimit;
                if (currentBalance < maxDDThreshold) {
                    console.log(`❌ MAX DRAWDOWN BREACH on ${day} (Trade ${trade.id})`);
                    console.log(`   Balance: $${currentBalance.toFixed(2)} < Threshold: $${maxDDThreshold.toFixed(2)}`);
                    failed = true;
                }
            }

            if (-dayPnL > rules.mavenDailyLimit) {
                console.log(`❌ DAILY DRAWDOWN BREACH on ${day}`);
                console.log(`   Day PnL: $${dayPnL.toFixed(2)} (Loss > $${rules.mavenDailyLimit})`);
                failed = true;
            }

            runningBalance += dayPnL;
        }

        console.log(`Final Evaluation: ${failed ? 'FAILED' : 'PASSED'}`);
        console.log(`Final Balance: $${runningBalance.toFixed(2)}`);

    } catch (e) {
        console.error(`Error parsing CSV for ${name}:`, e);
    }
}

async function main() {
    evaluateAccount("Maven 5k #2 (ID 760314)", CSV_MAVEN_2, RULES);
    evaluateAccount("Maven 5k #1 (ID 756009)", CSV_MAVEN_1, RULES);
}

main();
