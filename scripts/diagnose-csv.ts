
import fs from 'fs';
import { parse } from 'csv-parse/sync';

// Define the rules for EE 5k account (Phase 1)
const ACCOUNT_SIZE = 5000;
const DAILY_DRAWDOWN_PERCENT = 5; // 5%
const MAX_DRAWDOWN_PERCENT = 10; // 10%
const MAX_DRAWDOWN_TYPE = 'static'; // static

// Derived limits
const DAILY_DRAWDOWN_LIMIT = ACCOUNT_SIZE * (DAILY_DRAWDOWN_PERCENT / 100); // 250
const MAX_DRAWDOWN_LIMIT = ACCOUNT_SIZE * (MAX_DRAWDOWN_PERCENT / 100); // 500

const CSV_CONTENT = `ID,Symbol,Open Time,Volume,Side,Close Time,Open Price,Close Price,Stop Loss,Take Profit,Swap,Commission,Profit,Reason
W028578945957904,XAUUSD,14/10/2025 12:41:39,0.08,BUY,14/10/2025 12:57:53,4112.04,4106.62,4104.41,4176.00,0.00,-0.24,-43.60,User
W523554966956750,XAUUSD,14/10/2025 12:45:02,0.08,BUY,14/10/2025 12:57:53,4110.17,4106.62,4104.41,4133.47,0.00,-0.24,-28.64,User
W028578945947266,EURUSD,14/10/2025 08:06:46,1.50,BUY,14/10/2025 08:18:46,1.15577,1.15564,0.00000,1.15570,0.00,-4.50,-24.00,User
W523554966945343,EURUSD,14/10/2025 07:43:18,1.50,SELL,14/10/2025 08:05:35,1.15472,1.15574,1.15573,1.15412,0.00,-4.50,-157.50,SL
W523554966927149,US100,13/10/2025 14:52:23,2.80,SELL,13/10/2025 15:00:16,24600.71,24579.04,24598.03,24555.58,0.00,0.00,60.68,User
M004142506624792,US100,13/10/2025 14:02:20,2.50,BUY,13/10/2025 14:06:34,24720.04,24720.36,0.00,24767.63,0.00,0.00,0.80,User
W19066572673704992,US100,10/10/2025 14:02:17,14.00,SELL,10/10/2025 14:07:02,25131.08,25151.30,0.00,25095.41,0.00,0.00,-56.62,User
W19077251073702557,US100,10/10/2025 13:53:43,14.00,SELL,10/10/2025 13:57:02,25140.16,25160.83,0.00,25140.16,0.00,0.00,-57.88,User
W26252862113703046,US100,10/10/2025 13:50:15,14.00,SELL,10/10/2025 13:53:11,25157.50,25152.63,25156.70,25096.54,0.00,0.00,13.64,User
W19066572673703154,US100,10/10/2025 13:37:17,14.00,BUY,10/10/2025 13:49:50,25156.17,25149.43,25156.17,25227.60,0.00,0.00,-18.87,SL
W19077251073668972,US100,09/10/2025 14:50:12,14.00,BUY,09/10/2025 14:53:35,25037.04,25037.22,0.00,25135.99,0.00,0.00,0.50,User
W26252862113669527,US100,09/10/2025 14:44:52,15.00,SELL,09/10/2025 14:49:46,24999.23,25033.25,0.00,24980.05,0.00,0.00,-102.06,User
W19077251073663589,US100,09/10/2025 13:52:02,15.00,BUY,09/10/2025 14:21:18,25073.67,25051.73,25052.16,25192.30,0.00,0.00,-65.82,SL
M19066572673657875,EURUSD,09/10/2025 11:36:48,0.50,SELL,09/10/2025 12:57:04,1.16161,1.16159,1.16159,1.15881,0.00,-1.50,-0.50,SL
W19077251073653893,XAUUSD,09/10/2025 11:00:49,0.05,SELL,09/10/2025 11:38:41,4045.47,4042.47,4042.47,4024.87,0.00,-0.16,14.84,SL
W19077251073653893,XAUUSD,09/10/2025 11:00:49,0.05,SELL,09/10/2025 11:20:15,4045.47,4036.10,4042.47,4023.97,0.00,-0.16,46.69,Partial
W19077251073654179,XAUUSD,09/10/2025 11:05:20,0.08,SELL,09/10/2025 11:14:08,4041.58,4039.00,4045.30,4013.92,0.00,-0.24,20.40,User
M19066572673628375,US100,08/10/2025 14:30:31,7.00,BUY,08/10/2025 14:50:22,25021.87,24983.05,24983.40,25097.88,0.00,0.00,-54.35,SL
M26252862113587191,US100,07/10/2025 15:04:45,14.00,SELL,07/10/2025 15:05:41,24934.79,24913.54,0.00,24913.63,0.00,0.00,59.50,TP
M19077251073584796,US100,07/10/2025 14:35:40,14.00,SELL,07/10/2025 14:59:37,25006.25,24980.28,25005.89,24920.48,0.00,0.00,72.72,User
W26252862113580207,US100,07/10/2025 13:36:18,14.00,SELL,07/10/2025 13:55:38,25050.27,25050.19,25049.78,24921.34,0.00,0.00,0.22,SL
W19077251073500552,US100,03/10/2025 13:40:01,14.00,BUY,03/10/2025 13:41:39,24946.77,24907.73,24907.78,25009.78,0.00,0.00,-109.31,SL
M19077251073495480,US100,03/10/2025 11:45:11,5.00,BUY,03/10/2025 11:58:25,24943.67,24919.70,24919.97,24943.67,0.00,0.00,-23.97,SL
W19066572673470068,US100,02/10/2025 14:07:07,6.00,BUY,02/10/2025 14:11:38,24840.21,24834.23,24834.58,24961.59,0.00,0.00,-7.18,SL
W19066572673432409,US100,01/10/2025 13:55:14,14.00,BUY,01/10/2025 14:21:27,24558.59,24654.80,24559.66,24654.88,0.00,0.00,269.39,TP
W26252862113431583,US100,01/10/2025 13:52:44,3.00,BUY,01/10/2025 13:53:39,24532.03,24536.00,24504.73,24620.34,0.00,0.00,2.38,User
W19077251073429484,US100,01/10/2025 13:48:51,5.00,BUY,01/10/2025 13:49:41,24556.64,24521.31,24522.49,24690.90,0.00,0.00,-35.33,SL
W19077251073356428,US100,29/09/2025 15:37:49,14.00,SELL,29/09/2025 15:44:51,24627.96,24638.70,24666.11,24625.81,0.00,0.00,-30.07,User
W19066572673353574,US100,29/09/2025 14:20:31,13.00,SELL,29/09/2025 14:22:04,24694.75,24718.74,0.00,24675.48,0.00,0.00,-62.37,User
W26252862113352561,US100,29/09/2025 14:16:35,8.00,BUY,29/09/2025 14:20:05,24721.75,24695.38,24695.76,24802.20,0.00,0.00,-42.19,SL
W26252862113311998,US100,26/09/2025 13:40:44,9.00,BUY,26/09/2025 13:45:11,24454.90,24424.61,24425.06,24534.60,0.00,0.00,-54.52,SL
W26252862113308740,US100,26/09/2025 13:01:09,14.00,SELL,26/09/2025 13:05:28,24448.56,24443.95,0.00,24435.87,0.00,0.00,12.91,User
W26252862113308374,US100,26/09/2025 12:53:56,15.00,SELL,26/09/2025 12:58:31,24458.93,24471.32,0.00,24399.54,0.00,0.00,-37.17,User
W19077251073273318,US100,25/09/2025 13:40:02,15.00,SELL,25/09/2025 13:40:52,24235.80,24222.00,0.00,0.00,0.00,0.00,41.40,User
W26252862113273264,US100,25/09/2025 13:30:18,14.00,SELL,25/09/2025 13:37:48,24321.30,24250.25,24297.16,24230.76,0.00,0.00,198.94,User
W26252862113272633,US100,25/09/2025 13:20:11,13.00,BUY,25/09/2025 13:21:43,24347.13,24341.80,0.00,24350.02,0.00,0.00,-13.86,User
W19066572673272219,US100,25/09/2025 13:10:40,15.00,SELL,25/09/2025 13:18:43,24310.05,24334.63,24334.62,24010.82,0.00,0.00,-73.74,SL
W26252862113192236,US100,23/09/2025 14:06:53,14.00,BUY,23/09/2025 15:29:23,24710.48,24714.45,24686.85,24785.12,0.00,0.00,11.12,User
W19077251073190216,US100,23/09/2025 13:52:48,12.00,BUY,23/09/2025 13:55:10,24726.48,24699.90,24700.19,24785.84,0.00,0.00,-63.79,SL
W19066572673175777,USDJPY,23/09/2025 09:00:40,1.10,SELL,23/09/2025 09:45:02,147.524,147.605,147.598,147.092,0.00,-3.30,-63.66,SL
W19077251073147570,US100,22/09/2025 13:25:02,10.00,BUY,22/09/2025 14:06:58,24562.48,24637.65,24572.31,24637.50,0.00,0.00,150.34,TP
W19066572673109308,US100,19/09/2025 13:36:38,9.00,BUY,19/09/2025 13:40:36,24512.10,24513.15,24488.66,24512.10,0.00,0.00,1.89,TP
W26252862113097588,EURUSD,19/09/2025 08:19:49,0.25,SELL,19/09/2025 08:54:50,1.17569,1.17601,1.17782,1.17569,0.00,-0.76,-8.76,User
M19066572673072579,US100,18/09/2025 14:08:23,14.00,BUY,18/09/2025 14:09:48,24492.73,24495.65,0.00,24511.86,0.00,0.00,8.18,User
M19066572673072329,US100,18/09/2025 14:06:31,14.00,BUY,18/09/2025 14:08:03,24484.60,24487.40,24484.60,24512.63,0.00,0.00,7.84,User
M19077251073072930,US100,18/09/2025 14:05:55,14.00,BUY,18/09/2025 14:06:18,24482.60,24481.53,0.00,24511.86,0.00,0.00,-3.00,User
M19077251073072172,US100,18/09/2025 14:00:45,12.00,BUY,18/09/2025 14:05:17,24458.73,24479.78,24458.73,24479.56,0.00,0.00,50.52,TP
M19066572673068734,US100,18/09/2025 13:41:21,4.00,SELL,18/09/2025 14:00:31,24402.40,24465.50,24460.97,24277.40,0.00,0.00,-50.48,SL
M19066572673068733,US100,18/09/2025 13:41:21,4.00,SELL,18/09/2025 14:00:31,24402.40,24465.50,24460.97,24239.46,0.00,0.00,-50.48,SL
M19066572673068697,US100,18/09/2025 13:41:10,4.00,SELL,18/09/2025 13:41:45,24387.28,24386.23,24460.97,0.00,0.00,0.00,0.84,User
M19066572673042609,EURUSD,18/09/2025 04:30:58,0.18,SELL,18/09/2025 07:05:52,1.18075,1.18063,1.18067,1.17764,0.00,-0.54,1.62,User
M19066572673042609,EURUSD,18/09/2025 04:30:58,0.17,SELL,18/09/2025 05:29:16,1.18075,1.17981,1.18075,1.17764,0.00,-0.52,15.46,Partial
W26252862113040264,US100,17/09/2025 19:36:09,4.00,BUY,17/09/2025 19:42:48,24260.32,24260.34,24163.47,24260.32,0.00,0.00,0.02,TP
W26252862113037798,US100,17/09/2025 18:39:43,15.00,SELL,17/09/2025 18:40:04,24083.30,24075.50,0.00,0.00,0.00,0.00,23.40,User
W26252862113037407,US100,17/09/2025 18:32:41,14.00,SELL,17/09/2025 18:32:58,24127.50,24107.10,0.00,0.00,0.00,0.00,57.12,User
W19066572673034548,US100,17/09/2025 18:28:02,15.00,BUY,17/09/2025 18:31:08,24183.44,24165.36,0.00,24265.94,0.00,0.00,-54.24,User
W19077251073035928,US100,17/09/2025 18:22:25,8.00,BUY,17/09/2025 18:27:06,24143.29,24144.44,24146.36,24266.52,0.00,0.00,1.84,SL
W26252862113037093,US100,17/09/2025 18:25:30,7.00,BUY,17/09/2025 18:26:29,24164.41,24159.47,0.00,24185.96,0.00,0.00,-6.92,User
W19077251073035928,US100,17/09/2025 18:22:25,7.00,BUY,17/09/2025 18:25:10,24143.29,24154.40,24146.36,24266.52,0.00,0.00,15.55,Partial
W26252862113036342,US100,17/09/2025 18:13:34,6.00,SELL,17/09/2025 18:17:15,24123.84,24117.33,0.00,0.00,0.00,0.00,7.81,User
W26252862113036342,US100,17/09/2025 18:13:34,8.00,SELL,17/09/2025 18:15:44,24123.84,24079.80,24120.39,0.00,0.00,0.00,70.46,Partial
W19066572673022413,US100,17/09/2025 13:59:03,14.00,BUY,17/09/2025 14:01:30,24233.60,24214.78,24214.84,24290.55,0.00,0.00,-52.70,SL
W19077251073008036,XAUUSD,17/09/2025 08:40:30,0.10,SELL,17/09/2025 09:13:52,3664.85,3668.15,3668.09,3657.00,0.00,-0.30,-33.30,SL
W19077251072917381,EURUSD,15/09/2025 07:40:25,1.50,BUY,15/09/2025 07:42:50,1.17426,1.17414,1.17414,1.17477,0.00,-4.50,-22.50,SL
W19077251072897275,US100,12/09/2025 14:17:46,15.00,SELL,12/09/2025 14:21:11,24025.65,24041.73,24040.96,23949.78,0.00,0.00,-48.24,SL
W19077251072853025,US100,11/09/2025 13:53:07,9.00,SELL,11/09/2025 14:06:41,23940.90,23971.10,23970.37,23835.43,0.00,0.00,-54.36,SL
W19077251072811602,US100,10/09/2025 13:43:19,5.00,SELL,10/09/2025 14:03:45,23909.15,23936.10,23935.68,23851.83,0.00,0.00,-26.95,SL
W19077251072769547,US100,09/09/2025 14:18:23,5.00,BUY,09/09/2025 14:32:12,23781.00,23750.01,23750.74,23864.00,0.00,0.00,-30.99,SL
W26252862112724197,US100,08/09/2025 14:27:18,12.00,SELL,08/09/2025 14:30:23,23808.53,23834.65,23833.70,23710.00,0.00,0.00,-62.69,SL
W19077251072678762,US100,05/09/2025 14:03:25,3.00,SELL,05/09/2025 14:18:50,23787.28,23665.48,23762.43,23666.00,0.00,0.00,73.08,TP
W19077251072678762,US100,05/09/2025 14:03:25,3.00,SELL,05/09/2025 14:18:28,23787.28,23689.35,23834.46,23666.00,0.00,0.00,58.76,Partial
W26252862112341697,US100,26/08/2025 13:53:16,3.00,SELL,26/08/2025 14:10:32,23407.03,23450.33,23450.28,23423.70,0.00,0.00,-25.98,SL
M19077251072289537,US100,25/08/2025 13:35:13,10.00,SELL,25/08/2025 13:38:41,23412.15,23438.60,23437.99,23362.15,0.00,0.00,-52.90,SL
W26252862112227134,US100,21/08/2025 14:56:02,5.00,BUY,21/08/2025 15:11:08,23211.85,23169.07,23170.92,23294.30,0.00,0.00,-42.78,SL
W19066572672085110,US100,18/08/2025 17:37:06,5.00,BUY,18/08/2025 18:23:19,23688.13,23680.91,23656.45,0.00,0.00,0.00,-7.22,User
M19066572672048139,EURUSD,18/08/2025 07:19:48,0.20,BUY,18/08/2025 07:37:28,1.16972,1.16978,1.16926,1.17099,0.00,-0.60,0.60,User
M19077251072034361,US100,15/08/2025 17:35:24,10.00,SELL,15/08/2025 17:55:21,23726.37,23728.86,23738.05,23676.37,0.00,0.00,-4.98,User
W19077251072024832,US100,15/08/2025 14:00:00,10.00,BUY,15/08/2025 14:23:36,23684.00,23768.92,23679.09,23820.68,0.00,0.00,169.84,User
M19066572671998190,XAUUSD,15/08/2025 05:24:21,0.01,SELL,15/08/2025 06:50:28,3343.51,3343.36,3357.00,3302.00,0.00,-0.04,0.11,User
M19077251071990279,US100,14/08/2025 18:06:50,10.00,SELL,14/08/2025 18:17:58,23837.32,23815.77,23834.82,23772.00,0.00,0.00,43.10,User
M19077251071989293,US100,14/08/2025 17:42:55,10.00,SELL,14/08/2025 18:01:03,23855.95,23854.75,23880.24,23853.45,0.00,0.00,2.40,User
M26252862111989503,US100,14/08/2025 16:02:01,10.00,SELL,14/08/2025 16:31:07,23819.15,23798.45,23816.65,23699.59,0.00,0.00,41.40,User
M19066572671982787,US100,14/08/2025 15:08:39,10.00,SELL,14/08/2025 15:48:10,23854.45,23823.46,23849.45,23500.00,0.00,0.00,61.98,User
M26252862111953007,XAUUSD,14/08/2025 07:35:33,0.01,BUY,14/08/2025 07:55:35,3358.18,3348.68,3342.00,3482.00,0.00,-0.04,-9.54,User
M19066572671917298,US100,13/08/2025 13:57:56,10.00,SELL,13/08/2025 14:55:17,23929.38,23868.00,23879.38,23854.38,0.00,0.00,122.76,User
W19077251071887666,XAUUSD,13/08/2025 07:16:37,0.04,BUY,13/08/2025 10:48:55,3356.70,3364.88,3357.95,3482.00,0.00,-0.12,32.60,User
W26252862111891619,XAUUSD,13/08/2025 07:20:21,0.10,BUY,13/08/2025 08:41:07,3358.93,3359.40,3348.59,3380.34,0.00,-0.30,4.40,User
W26252862111891619,XAUUSD,13/08/2025 07:20:21,0.05,BUY,13/08/2025 08:40:18,3358.93,3359.75,3348.59,3380.34,0.00,-0.16,3.94,Partial
M26252862111865407,US500,12/08/2025 13:49:26,21,SELL,12/08/2025 14:08:10,6394.2,6407.6,0.0,6369.6,0.00,0.00,-140.70,User
W19066572671860711,US500,12/08/2025 13:34:38,10,SELL,12/08/2025 13:39:16,6411.2,6415.3,6419.9,6369.5,0.00,0.00,-20.50,User
W26252862111838689,GBPUSD,12/08/2025 07:26:09,1.00,SELL,12/08/2025 07:29:43,1.34439,1.34479,1.34477,1.34316,0.00,-3.00,-43.00,SL
M26252862111817401,US100,11/08/2025 15:08:38,3.00,SELL,11/08/2025 15:13:30,23622.32,23634.08,23634.00,23566.00,0.00,0.00,-7.06,SL
W19077251071812901,US100,11/08/2025 14:49:46,6.00,SELL,11/08/2025 14:50:01,23627.39,23625.25,23665.38,0.00,0.00,0.00,2.57,User
W26252862111808223,US100,11/08/2025 13:45:59,5.00,BUY,11/08/2025 14:43:06,23613.75,23645.19,23619.61,23858.00,0.00,0.00,31.44,User
W26252862111808223,US100,11/08/2025 13:45:59,1.00,BUY,11/08/2025 14:40:53,23613.75,23640.71,23619.61,23858.00,0.00,0.00,5.39,Partial
W26252862111808223,US100,11/08/2025 13:45:59,4.00,BUY,11/08/2025 14:27:34,23613.75,23652.07,23616.58,23858.00,0.00,0.00,30.66,Partial
M19066572671756184,US500,08/08/2025 14:16:49,4,SELL,08/08/2025 14:21:38,6376.2,6380.2,6385.0,6376.2,0.00,0.00,-8.00,User
W19077251071753788,US500,08/08/2025 14:01:07,17,BUY,08/08/2025 14:14:36,6379.0,6379.4,6379.4,6401.1,0.00,0.00,3.40,SL
W19077251071753788,US500,08/08/2025 14:01:07,5,BUY,08/08/2025 14:09:27,6379.0,6384.3,6379.4,6401.1,0.00,0.00,13.25,Partial
W26252862111753608,US500,08/08/2025 13:33:04,8,SELL,08/08/2025 13:42:21,6360.1,6365.7,6365.7,6309.0,0.00,0.00,-22.40,SL
W19077251071694469,US100,07/08/2025 13:50:13,4.00,SELL,07/08/2025 13:55:44,23502.75,23531.12,23530.13,23429.06,0.00,0.00,-22.70,SL
W19077251071692758,US500,07/08/2025 13:42:15,12,BUY,07/08/2025 13:45:19,6385.3,6376.9,6377.1,6407.8,0.00,0.00,-50.40,SL
M19066572671679346,XAUUSD,07/08/2025 11:01:36,0.02,SELL,07/08/2025 11:18:56,3372.33,3380.43,3383.00,3351.00,0.00,-0.06,-16.26,User
M19066572671678797,XAUUSD,07/08/2025 10:53:57,0.15,SELL,07/08/2025 11:01:06,3373.04,3373.01,3383.00,3373.04,0.00,-0.46,-0.01,TP
W19077251071661771,GBPUSD,07/08/2025 07:04:55,1.00,SELL,07/08/2025 07:37:32,1.33742,1.33773,1.33772,1.33460,0.00,-3.00,-34.00,SL
M19066572671628330,US500,06/08/2025 13:37:57,7,SELL,06/08/2025 13:44:09,6308.2,6306.8,6307.3,6290.0,0.00,0.00,4.90,User
M26252862111631210,US100,06/08/2025 13:39:19,11.00,SELL,06/08/2025 13:43:03,23045.75,23068.88,23068.47,22998.00,0.00,0.00,-50.89,SL
W19077251071597825,EURUSD,06/08/2025 07:41:05,0.50,SELL,06/08/2025 07:46:30,1.15774,1.15801,1.15801,1.15644,0.00,-1.50,-15.00,SL
W26252862111584497,US100,05/08/2025 17:33:46,3.00,BUY,05/08/2025 18:30:27,23095.86,23054.32,23054.42,23276.91,0.00,0.00,-24.92,SL
W19066572671537322,GBPUSD,05/08/2025 08:04:16,0.29,BUY,05/08/2025 08:47:25,1.32681,1.32697,1.32698,1.32955,0.00,-0.88,3.76,SL`;

interface Trade {
    id: string;
    symbol: string;
    openTime: string; // DD/MM/YYYY HH:mm:ss
    closeTime: string; // DD/MM/YYYY HH:mm:ss
    profit: number;
    commission: number;
    closeDate: string; // YYYY-MM-DD
}

function parseDate(dateStr: string): string {
    // Input: 14/10/2025 12:41:39
    // Output: YYYY-MM-DD
    const parts = dateStr.split(' ');
    const dateParts = parts[0].split('/');
    // dateParts[0] = Day, dateParts[1] = Month, dateParts[2] = Year
    return `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
}

async function main() {
    console.log('Evaluating EE 5k CSV Data...');
    console.log(`Rules: Daily Loss < $${DAILY_DRAWDOWN_LIMIT}, Max Loss < $${MAX_DRAWDOWN_LIMIT} (Start Bal: $${ACCOUNT_SIZE})`);

    try {
        const records = parse(CSV_CONTENT, {
            columns: true,
            skip_empty_lines: true,
            trim: true
        });

        const trades: Trade[] = records.filter((r: any) => r.ID !== 'Total').map((r: any) => ({
            id: r.ID,
            symbol: r.Symbol,
            openTime: r['Open Time'],
            closeTime: r['Close Time'],
            profit: parseFloat(r.Profit),
            commission: parseFloat(r.Commission),
            closeDate: parseDate(r['Close Time'])
        }));

        // Sort by Close Time (ascending) to replay history
        trades.sort((a, b) => {
            // Parse full date time for sorting
            const parseDT = (dt: string) => {
                const [d, t] = dt.split(' ');
                const [day, month, year] = d.split('/');
                return new Date(`${year}-${month}-${day}T${t}Z`).getTime();
            };
            return parseDT(a.closeTime) - parseDT(b.closeTime);
        });

        console.log(`Loaded ${trades.length} trades.`);

        // Evaluation
        let currentBalance = ACCOUNT_SIZE;
        let highWaterMark = ACCOUNT_SIZE;
        let failed = false;

        // Group by Day (UTC)
        const tradesByDay = new Map<string, Trade[]>();
        for (const trade of trades) {
            if (!tradesByDay.has(trade.closeDate)) {
                tradesByDay.set(trade.closeDate, []);
            }
            tradesByDay.get(trade.closeDate)!.push(trade);
        }

        const sortedDays = Array.from(tradesByDay.keys()).sort();

        let runningBalance = ACCOUNT_SIZE;

        for (const day of sortedDays) {
            const dayTrades = tradesByDay.get(day)!;
            const dayStartBalance = runningBalance;
            let dayPnL = 0;

            // console.log(`Processing Day: ${day} (Start Bal: $${dayStartBalance.toFixed(2)})`);

            for (const trade of dayTrades) {
                const netPnl = trade.profit + trade.commission; // Commission in CSV is negative usually? csv says -0.24. Profit -43.60. usually net = profit + commission (if comm is negative).
                // Let's verify CSV profit column. Usually "Profit" in MT4/5 is Gross Profit? Or Net?
                // The footer says Total Profit -382.49.
                // Let's assume Profit column IS Net Profit or we sum them? 
                // Wait, typical CSV export: Profit is gross?
                // Let's Assume Net PnL = Profit + Commission (since commission is negative)
                // Actually looking at row 1: Profit -43.60. Commission -0.24.
                // If Profit is already Net, then -43.60. If Gross, then -43.84.
                // Let's assume standard behavior: Profit is Gross PnL.

                const totalTradePnL = trade.profit + trade.commission + parseFloat(records.find((r: any) => r.ID === trade.id)?.Swap || 0);

                dayPnL += totalTradePnL;

                const currentBalance = dayStartBalance + dayPnL;
                if (currentBalance > highWaterMark) highWaterMark = currentBalance;

                // Check Max DD
                // Static Max DD = Starting Balance - 10%
                const maxDDLimit = ACCOUNT_SIZE - MAX_DRAWDOWN_LIMIT;

                if (currentBalance < maxDDLimit) {
                    console.log(`❌ MAX DRAWDOWN BREACH on ${day} (Trade ${trade.id})`);
                    console.log(`   Balance: $${currentBalance.toFixed(2)} < Limit: $${maxDDLimit.toFixed(2)}`);
                    failed = true;
                }
            }

            const dailyLimit = DAILY_DRAWDOWN_LIMIT; // 250
            if (dayPnL < -dailyLimit) {
                console.log(`❌ DAILY DRAWDOWN BREACH on ${day}`);
                console.log(`   Day PnL: $${dayPnL.toFixed(2)} (Loss > $${dailyLimit})`);
                console.log(`   Trades provided: ${dayTrades.length}`);
                failed = true;
            } else {
                // console.log(`   Day PnL: $${dayPnL.toFixed(2)} (OK)`);
            }

            runningBalance += dayPnL;
        }

        console.log('--------------------------------------------------');
        console.log(`Final Evaluation Result: ${failed ? 'FAILED' : 'PASSED'}`);
        console.log(`Final Balance: $${runningBalance.toFixed(2)}`);

    } catch (e) {
        console.error("Error parsing CSV:", e);
    }
}

main();
