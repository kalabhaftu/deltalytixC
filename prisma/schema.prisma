generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["public"]
}

enum TradingModel {
  ICT_2022
  MSNR
  TTFM
  PRICE_ACTION

  @@schema("public")
}

model Trade {
  id                String        @id @default(uuid())
  accountNumber     String
  quantity          Float         @default(0)
  entryId           String?       @default("")
  closeId           String?       @default("")
  instrument        String
  entryPrice        String
  closePrice        String
  entryDate         String
  closeDate         String
  pnl               Float
  timeInPosition    Float         @default(0)
  userId            String
  side              String?       @default("")
  commission        Float         @default(0)
  createdAt         DateTime      @default(now())
  comment           String?
  imageBase64       String?
  imageBase64Second String?
  groupId           String?       @default("")
  imageBase64Third  String?
  imageBase64Fourth String?
  imageBase64Fifth  String? // Fifth screenshot
  imageBase64Sixth  String? // Sixth screenshot
  cardPreviewImage  String? // Optimized preview image for journal cards
  accountId         String?
  phaseAccountId    String? // Relation to PhaseAccount for prop firm trades
  symbol            String?
  entryTime         DateTime?
  exitTime          DateTime?
  closeReason       String?
  stopLoss          String? // Stop loss price from Match Trader CSV
  takeProfit        String? // Take profit price from Match Trader CSV
  tradingModel      TradingModel? // Trading model used (ICT 2022, MSNR, TTFM, Price Action)
  account           Account?      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  phaseAccount      PhaseAccount? @relation(fields: [phaseAccountId], references: [id], onDelete: Cascade)

  @@index([accountNumber])
  @@index([userId])
  @@index([groupId])
  @@index([accountId])
  @@index([phaseAccountId])
  @@index([entryTime])
  @@index([symbol])
  @@index([accountId, phaseAccountId])
  @@index([exitTime])
  @@index([accountId, exitTime])
  @@index([userId, accountNumber])
  @@index([userId, entryTime])
  @@index([entryId]) // CRITICAL: Fast duplicate detection for large imports
  @@index([closeId]) // CRITICAL: Fast duplicate detection for large imports
  @@index([userId, entryId]) // Compound index for optimal query performance
  @@index([userId, closeId]) // Compound index for optimal query performance
  @@schema("public")
}

// TickDetails model removed - tick details feature was fully deleted from application

// Notification model removed - no notification functionality in application
// Only referenced in account deletion cleanup (can use direct SQL if needed)

model User {
  id                    String              @id @default(cuid())
  email                 String              @unique
  auth_user_id          String              @unique
  isFirstConnection     Boolean             @default(true)
  thorToken             String?
  timezone              String              @default("UTC")
  theme                 String              @default("system")
  firstName             String?
  lastName              String?
  accountFilterSettings String? // JSON string storing account filter preferences
  backtestInputMode     String              @default("manual") // "manual" or "simple"
  accounts              Account[]
  masterAccounts        MasterAccount[] // New relation for master accounts
  dashboardTemplates    DashboardTemplate[]
  groups                Group[]
  backtestTrades        BacktestTrade[] // Backtesting trades

  @@index([email])
  @@schema("public")
}

model Group {
  id        String    @id @default(uuid())
  name      String
  userId    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  accounts  Account[]
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
  @@index([userId])
  @@schema("public")
}

// New Master Account Model for Prop Firm Account Tracking
model MasterAccount {
  id             String   @id @default(uuid())
  userId         String
  accountName    String // e.g., "FTMO $100k Challenge"
  propFirmName   String // e.g., "FTMO", "The5ers", "Custom"
  accountSize    Float // e.g., 100000
  evaluationType String // "One Step", "Two Step", "Instant"
  currentPhase   Int // 1, 2, 3 for Funded - Crucial for state management
  isActive       Boolean  @default(true) // false if failed/passed
  createdAt      DateTime @default(now())

  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  phases  PhaseAccount[]
  payouts Payout[]

  @@index([userId])
  @@index([propFirmName])
  @@index([currentPhase])
  @@index([isActive])
  @@index([userId, isActive])
  @@schema("public")
}

// New Phase Account Model for Individual Phase Management
model PhaseAccount {
  id              String             @id @default(uuid())
  masterAccountId String
  phaseNumber     Int // 1 for Phase 1, 2 for Phase 2, 3 for Funded
  phaseId         String? // User-provided ID/Account Number (e.g., "753251")
  status          PhaseAccountStatus @default(active) // "active", "passed", "failed", "archived"

  // Rules object
  profitTargetPercent    Float
  dailyDrawdownPercent   Float
  maxDrawdownPercent     Float
  maxDrawdownType        String @default("static") // "static" or "trailing"
  minTradingDays         Int    @default(0) // can be 0
  timeLimitDays          Int? // null for unlimited
  consistencyRulePercent Float  @default(0) // can be 0 for none

  // Payout config (only relevant for Funded phase)
  profitSplitPercent Float? // only for funded
  payoutCycleDays    Int? // only for funded

  startDate DateTime  @default(now())
  endDate   DateTime? // null if active

  masterAccount MasterAccount  @relation(fields: [masterAccountId], references: [id], onDelete: Cascade)
  trades        Trade[]
  dailyAnchors  DailyAnchor[]
  breachRecords BreachRecord[]
  payouts       Payout[]

  @@index([masterAccountId])
  @@index([phaseNumber])
  @@index([status])
  @@index([phaseId])
  @@index([masterAccountId, phaseNumber])
  @@index([masterAccountId, status])
  @@schema("public")
}

// Payout Model for Tracking Funded Account Withdrawals
model Payout {
  id String @id @default(cuid())

  // Relations
  masterAccountId String
  masterAccount   MasterAccount @relation(fields: [masterAccountId], references: [id], onDelete: Cascade)

  phaseAccountId String
  phaseAccount   PhaseAccount @relation(fields: [phaseAccountId], references: [id], onDelete: Cascade)

  // Payout details
  amount       Float
  status       String    @default("pending") // pending, approved, paid, rejected
  requestDate  DateTime  @default(now())
  approvedDate DateTime?
  paidDate     DateTime?
  rejectedDate DateTime?

  // Optional metadata
  notes           String? @db.Text
  rejectionReason String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([masterAccountId])
  @@index([phaseAccountId])
  @@index([status])
  @@schema("public")
}

// Daily Anchor Model for Daily Drawdown Calculation
model DailyAnchor {
  id             String   @id @default(uuid())
  phaseAccountId String // Links to PhaseAccount for new architecture
  date           DateTime @db.Date
  anchorEquity   Float
  computedAt     DateTime @default(now())

  phaseAccount PhaseAccount @relation(fields: [phaseAccountId], references: [id], onDelete: Cascade)

  @@unique([phaseAccountId, date])
  @@index([phaseAccountId])
  @@index([date])
  @@schema("public")
}

// Breach History - Track all rule violations
model BreachRecord {
  id             String   @id @default(uuid())
  phaseAccountId String
  breachType     String // "daily_drawdown", "max_drawdown", "consistency_rule", "time_limit"
  breachAmount   Float // How much the rule was exceeded by
  breachTime     DateTime @default(now())

  // Snapshot of account state at breach
  currentEquity     Float
  accountSize       Float
  dailyStartBalance Float?
  highWaterMark     Float?

  // Additional context
  tradeId String? // The trade that caused the breach (if applicable)
  notes   String? // Additional context

  phaseAccount PhaseAccount @relation(fields: [phaseAccountId], references: [id], onDelete: Cascade)

  @@index([phaseAccountId])
  @@index([breachType])
  @@index([breachTime])
  @@schema("public")
}

// Live Trading Account Model (simplified, no prop firm fields)
model Account {
  id              String   @id @default(uuid())
  number          String
  name            String?
  broker          String?
  startingBalance Float    @default(0)
  userId          String
  groupId         String?
  createdAt       DateTime @default(now())

  group  Group?  @relation(fields: [groupId], references: [id])
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  trades Trade[]

  @@unique([number, userId])
  @@index([number])
  @@index([groupId])
  @@index([userId])
  @@schema("public")
}

model DashboardTemplate {
  id        String   @id @default(uuid())
  userId    String
  name      String
  isDefault Boolean  @default(false)
  isActive  Boolean  @default(false) // Currently selected template
  layout    Json     @default("[]") // Stores widget layout configuration
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@index([userId, isActive])
  @@index([userId, isDefault])
  @@schema("public")
}

// Shared model removed - trade sharing feature not implemented, was incomplete/unused

// Tag model removed - tags are stored as string array in Trade model, no separate Tag table used

// Order model removed - orders are processed in-memory during IBKR import, not persisted to database

// TradeAnalytics model removed - MAE/MFE analytics not actively used, no database queries found

// HistoricalData model removed - no database queries found, historical data not persisted

// FilterPreset model removed - no database queries found, filter presets not implemented

enum BreachType {
  daily_drawdown
  max_drawdown

  @@schema("public")
}

enum PhaseAccountStatus {
  active
  passed
  failed
  archived
  pending

  @@schema("public")
}

// Backtesting Enums
enum BacktestDirection {
  BUY
  SELL

  @@schema("public")
}

enum BacktestOutcome {
  WIN
  LOSS
  BREAKEVEN

  @@schema("public")
}

enum BacktestSession {
  ASIAN
  LONDON
  NEW_YORK

  @@schema("public")
}

enum BacktestModel {
  ICT_2022
  MSNR
  TTFM
  PRICE_ACTION
  SUPPLY_DEMAND
  SMART_MONEY
  CUSTOM

  @@schema("public")
}

// Backtesting Trade Model
model BacktestTrade {
  id                String            @id @default(uuid())
  userId            String
  
  // Core trade data
  pair              String
  direction         BacktestDirection
  outcome           BacktestOutcome
  session           BacktestSession
  model             BacktestModel
  customModel       String?
  
  // Risk/Reward and Performance
  riskRewardRatio   Float
  entryPrice        Float
  stopLoss          Float
  takeProfit        Float
  exitPrice         Float
  pnl               Float
  
  // Images (6 screenshots + 1 preview)
  imageOne          String?
  imageTwo          String?
  imageThree        String?
  imageFour         String?
  imageFive         String?
  imageSix          String?
  cardPreviewImage  String?
  
  // Metadata
  notes             String?
  tags              String[] // Array of tag strings
  dateExecuted      DateTime
  backtestDate      DateTime? // When the backtest was performed
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([userId, outcome])
  @@index([userId, session])
  @@index([userId, model])
  @@index([dateExecuted])
  @@schema("public")
}
