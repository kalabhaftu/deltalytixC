generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["public"]
}

model Trade {
  id                String        @id @default(uuid())
  accountNumber     String
  quantity          Float         @default(0)
  entryId           String?       @default("")
  instrument        String
  entryPrice        String
  closePrice        String
  entryDate         String
  closeDate         String
  pnl               Float
  timeInPosition    Float         @default(0)
  userId            String
  side              String?       @default("")
  commission        Float         @default(0)
  createdAt         DateTime      @default(now())
  comment           String?
  imageBase64       String?
  imageBase64Second String?
  groupId           String?       @default("")
  imageBase64Third  String?
  imageBase64Fourth String?
  imageBase64Fifth  String?
  imageBase64Sixth  String?
  cardPreviewImage  String?
  accountId         String?
  phaseAccountId    String?
  symbol            String?
  entryTime         DateTime?
  exitTime          DateTime?
  closeReason       String?
  stopLoss          String?
  takeProfit        String?
  tradingModel      TradingModel?
  account           Account?      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  phaseAccount      PhaseAccount? @relation(fields: [phaseAccountId], references: [id], onDelete: Cascade)

  @@index([accountNumber])
  @@index([userId])
  @@index([groupId])
  @@index([accountId])
  @@index([phaseAccountId])
  @@index([entryTime])
  @@index([symbol])
  @@index([accountId, phaseAccountId])
  @@index([exitTime])
  @@index([accountId, exitTime])
  @@index([userId, accountNumber])
  @@index([userId, entryTime])
  @@index([entryId])
  @@index([userId, entryId])
  @@schema("public")
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique
  auth_user_id            String                   @unique
  isFirstConnection       Boolean                  @default(true)
  thorToken               String?
  timezone                String                   @default("UTC")
  theme                   String                   @default("system")
  firstName               String?
  lastName                String?
  accountFilterSettings   String?
  backtestInputMode       String                   @default("manual")
  customTradingModels     String?                  @db.Text // JSON array of custom model names
  accounts                Account[]
  backtestTrades          BacktestTrade[]
  dailyNotes              DailyNote[]
  dashboardTemplates      DashboardTemplate[]
  groups                  Group[]
  liveAccountTransactions LiveAccountTransaction[]
  masterAccounts          MasterAccount[]

  @@index([email])
  @@schema("public")
}

model Group {
  id        String    @id @default(uuid())
  name      String
  userId    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  accounts  Account[]
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
  @@index([userId])
  @@schema("public")
}

model MasterAccount {
  id             String              @id @default(uuid())
  userId         String
  accountName    String
  propFirmName   String
  accountSize    Float
  evaluationType String
  currentPhase   Int
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  status         MasterAccountStatus @default(active)
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  payouts        Payout[]
  phases         PhaseAccount[]

  @@index([userId])
  @@index([propFirmName])
  @@index([currentPhase])
  @@index([isActive])
  @@index([userId, isActive])
  @@index([status])
  @@index([userId, status])
  @@schema("public")
}

model PhaseAccount {
  id                     String             @id @default(uuid())
  masterAccountId        String
  phaseNumber            Int
  phaseId                String?
  status                 PhaseAccountStatus @default(active)
  profitTargetPercent    Float
  dailyDrawdownPercent   Float
  maxDrawdownPercent     Float
  maxDrawdownType        String             @default("static")
  minTradingDays         Int                @default(0)
  timeLimitDays          Int?
  consistencyRulePercent Float              @default(0)
  profitSplitPercent     Float?
  payoutCycleDays        Int?
  startDate              DateTime           @default(now())
  endDate                DateTime?
  breachRecords          BreachRecord[]
  dailyAnchors           DailyAnchor[]
  payouts                Payout[]
  masterAccount          MasterAccount      @relation(fields: [masterAccountId], references: [id], onDelete: Cascade)
  trades                 Trade[]

  @@index([masterAccountId])
  @@index([phaseNumber])
  @@index([status])
  @@index([phaseId])
  @@index([masterAccountId, phaseNumber])
  @@index([masterAccountId, status])
  @@schema("public")
}

model Payout {
  id              String        @id @default(cuid())
  masterAccountId String
  phaseAccountId  String
  amount          Float
  status          String        @default("pending")
  requestDate     DateTime      @default(now())
  approvedDate    DateTime?
  paidDate        DateTime?
  rejectedDate    DateTime?
  notes           String?
  rejectionReason String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  masterAccount   MasterAccount @relation(fields: [masterAccountId], references: [id], onDelete: Cascade)
  phaseAccount    PhaseAccount  @relation(fields: [phaseAccountId], references: [id], onDelete: Cascade)

  @@index([masterAccountId])
  @@index([phaseAccountId])
  @@index([status])
  @@schema("public")
}

model DailyAnchor {
  id             String       @id @default(uuid())
  phaseAccountId String
  date           DateTime     @db.Date
  anchorEquity   Float
  computedAt     DateTime     @default(now())
  phaseAccount   PhaseAccount @relation(fields: [phaseAccountId], references: [id], onDelete: Cascade)

  @@unique([phaseAccountId, date])
  @@index([phaseAccountId])
  @@index([date])
  @@schema("public")
}

model BreachRecord {
  id                String       @id @default(uuid())
  phaseAccountId    String
  breachType        String
  breachAmount      Float
  breachTime        DateTime     @default(now())
  currentEquity     Float
  accountSize       Float
  dailyStartBalance Float?
  highWaterMark     Float?
  tradeId           String?
  notes             String?
  phaseAccount      PhaseAccount @relation(fields: [phaseAccountId], references: [id], onDelete: Cascade)

  @@index([phaseAccountId])
  @@index([breachType])
  @@index([breachTime])
  @@schema("public")
}

model Account {
  id              String                   @id @default(uuid())
  number          String
  name            String?
  broker          String?
  startingBalance Float                    @default(0)
  userId          String
  groupId         String?
  createdAt       DateTime                 @default(now())
  group           Group?                   @relation(fields: [groupId], references: [id])
  user            User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions    LiveAccountTransaction[]
  trades          Trade[]

  @@unique([number, userId])
  @@index([number])
  @@index([groupId])
  @@index([userId])
  @@schema("public")
}

model DashboardTemplate {
  id        String   @id @default(uuid())
  userId    String
  name      String
  isDefault Boolean  @default(false)
  isActive  Boolean  @default(false)
  layout    Json     @default("[]")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@index([userId, isActive])
  @@index([userId, isDefault])
  @@schema("public")
}

model BacktestTrade {
  id               String            @id @default(uuid())
  userId           String
  pair             String
  direction        BacktestDirection
  outcome          BacktestOutcome
  session          BacktestSession
  model            BacktestModel
  customModel      String?
  riskRewardRatio  Float
  entryPrice       Float
  stopLoss         Float
  takeProfit       Float
  exitPrice        Float
  pnl              Float
  imageOne         String?
  imageTwo         String?
  imageThree       String?
  imageFour        String?
  imageFive        String?
  imageSix         String?
  cardPreviewImage String?
  notes            String?
  tags             String[]
  dateExecuted     DateTime
  backtestDate     DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  riskPoints       Float             @default(0)
  rewardPoints     Float             @default(0)
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, outcome])
  @@index([userId, session])
  @@index([userId, model])
  @@index([dateExecuted])
  @@schema("public")
}

model DailyNote {
  id        String   @id @default(uuid())
  userId    String
  date      DateTime @db.Date
  note      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@index([userId, date])
  @@schema("public")
}

model LiveAccountTransaction {
  id          String          @id @default(uuid())
  accountId   String
  userId      String
  type        TransactionType
  amount      Float
  description String?
  createdAt   DateTime        @default(now())
  account     Account         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([userId])
  @@index([createdAt])
  @@index([accountId, createdAt])
  @@schema("public")
}

enum TradingModel {
  ICT_2022
  MSNR
  TTFM
  PRICE_ACTION

  @@schema("public")
}

enum BreachType {
  daily_drawdown
  max_drawdown

  @@schema("public")
}

enum PhaseAccountStatus {
  active
  passed
  failed
  archived
  pending

  @@schema("public")
}

enum MasterAccountStatus {
  active
  funded
  failed

  @@schema("public")
}

enum BacktestDirection {
  BUY
  SELL

  @@schema("public")
}

enum BacktestOutcome {
  WIN
  LOSS
  BREAKEVEN

  @@schema("public")
}

enum BacktestSession {
  ASIAN
  LONDON
  NEW_YORK

  @@schema("public")
}

enum BacktestModel {
  ICT_2022
  MSNR
  TTFM
  PRICE_ACTION
  SUPPLY_DEMAND
  SMART_MONEY
  CUSTOM

  @@schema("public")
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL

  @@schema("public")
}
