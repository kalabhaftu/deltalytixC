generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas  = ["public"]
}

enum TradingModel {
  ICT_2022
  MSNR
  TTFM
  PRICE_ACTION

  @@schema("public")
}

model Trade {
  id                String        @id @default(uuid())
  accountNumber     String
  quantity          Int
  entryId           String?       @default("")
  closeId           String?       @default("")
  instrument        String
  entryPrice        String
  closePrice        String
  entryDate         String
  closeDate         String
  pnl               Float
  timeInPosition    Float         @default(0)
  userId            String
  side              String?       @default("")
  commission        Float         @default(0)
  createdAt         DateTime      @default(now())
  comment           String?
  videoUrl          String?
  tags              String[]      @default([])
  imageBase64       String?
  imageBase64Second String?
  groupId           String?       @default("")
  imageBase64Third  String?
  imageBase64Fourth String?
  imageBase64Fifth  String?       // Fifth screenshot
  imageBase64Sixth  String?       // Sixth screenshot
  cardPreviewImage  String?       // Optimized preview image for journal cards
  accountId         String?
  phaseAccountId    String?           // Relation to PhaseAccount for prop firm trades
  symbol            String?
  strategy          String?
  fees              Float?        @default(0)
  realizedPnl       Float?
  entryTime         DateTime?
  exitTime          DateTime?
  equityAtOpen      Float?
  equityAtClose     Float?
  rawBrokerId       String?
  closeReason       String?
  tradingModel      TradingModel?   // Trading model used (ICT 2022, MSNR, TTFM, Price Action)
  account           Account?      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  phaseAccount      PhaseAccount? @relation(fields: [phaseAccountId], references: [id], onDelete: SetNull)
  tradeAnalytics    TradeAnalytics?

  @@index([accountNumber])
  @@index([userId])
  @@index([groupId])
  @@index([accountId])
  @@index([phaseAccountId])
  @@index([entryTime])
  @@index([symbol])
  @@index([accountId, phaseAccountId])
  @@index([exitTime])
  @@index([accountId, exitTime])
  @@index([userId, accountNumber])
  @@index([userId, entryTime])
  @@schema("public")
}

model TickDetails {
  id        String @id @default(uuid())
  ticker    String
  tickValue Float
  tickSize  Float

  @@schema("public")
}

model Notification {
  id          String    @id @default(cuid())
  userId      String
  title       String
  description String
  createdAt   DateTime  @default(now())
  readAt      DateTime?
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@schema("public")
}

model User {
  id                String           @id @default(cuid())
  email             String           @unique
  auth_user_id      String           @unique
  isBeta            Boolean          @default(false)
  isFirstConnection Boolean          @default(true)
  etpToken          String?
  thorToken         String?
  language          String           @default("en")
  twoFactorSecret   String?
  twoFactorEnabled  Boolean          @default(false)
  lastLoginAt       DateTime?
  loginAttempts     Int              @default(0)
  lockedUntil       DateTime?
  timezone          String           @default("UTC")
  theme             String           @default("system")
  firstName         String?
  lastName          String?
  accountFilterSettings String?        // JSON string storing account filter preferences
  accounts          Account[]
  masterAccounts    MasterAccount[]   // New relation for master accounts
  dashboardLayout   DashboardLayout?
  groups            Group[]
  notifications     Notification[]
  orders            Order[]
  tags              Tag[]

  @@index([email])
  @@schema("public")
}

model Group {
  id        String    @id @default(uuid())
  name      String
  userId    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  accounts  Account[]
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
  @@index([userId])
  @@schema("public")
}

// New Master Account Model for Prop Firm Account Tracking
model MasterAccount {
  id                String                 @id @default(uuid())
  userId            String
  accountName       String                 // e.g., "FTMO $100k Challenge"
  propFirmName      String                 // e.g., "FTMO", "The5ers", "Custom"
  accountSize       Float                  // e.g., 100000
  evaluationType    String                 // "One Step", "Two Step", "Instant"
  currentPhase      Int                    // 1, 2, 3 for Funded - Crucial for state management
  isActive          Boolean                @default(true) // false if failed/passed
  createdAt         DateTime               @default(now())
  
  user              User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  phases            PhaseAccount[]
  
  @@index([userId])
  @@index([propFirmName])
  @@index([currentPhase])
  @@index([isActive])
  @@index([userId, isActive])
  @@schema("public")
}

// New Phase Account Model for Individual Phase Management
model PhaseAccount {
  id                           String               @id @default(uuid())
  masterAccountId              String
  phaseNumber                  Int                  // 1 for Phase 1, 2 for Phase 2, 3 for Funded
  phaseId                      String?              // User-provided ID/Account Number (e.g., "753251")
  status                       PhaseAccountStatus   @default(active) // "active", "passed", "failed", "archived"
  
  // Rules object
  profitTargetPercent          Float
  dailyDrawdownPercent         Float
  maxDrawdownPercent           Float
  minTradingDays               Int                  @default(0) // can be 0
  timeLimitDays                Int                  @default(0) // can be 0 for unlimited
  consistencyRulePercent       Float                @default(0) // can be 0 for none
  
  // Payout config (only relevant for Funded phase)
  profitSplitPercent           Float?               // only for funded
  payoutCycleDays              Int?                 // only for funded
  
  startDate                    DateTime             @default(now())
  endDate                      DateTime?            // null if active
  
  masterAccount                MasterAccount        @relation(fields: [masterAccountId], references: [id], onDelete: Cascade)
  trades                       Trade[]
  
  @@index([masterAccountId])
  @@index([phaseNumber])
  @@index([status])
  @@index([phaseId])
  @@index([masterAccountId, phaseNumber])
  @@index([masterAccountId, status])
  @@schema("public")
}

// Live Trading Account Model (simplified, no prop firm fields)
model Account {
  id                         String              @id @default(uuid())
  number                     String
  name                       String?
  broker                     String?
  startingBalance            Float               @default(0)
  userId                     String
  groupId                    String?
  createdAt                  DateTime            @default(now())
  
  group                      Group?              @relation(fields: [groupId], references: [id])
  user                       User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  trades                     Trade[]

  @@unique([number, userId])
  @@index([number])
  @@index([groupId])
  @@index([userId])
  @@schema("public")
}


model DashboardLayout {
  id        String   @id @default(uuid())
  userId    String   @unique
  desktop   Json     @default("[]")
  mobile    Json     @default("[]")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@schema("public")
}

model Shared {
  id             String    @id @default(uuid())
  userId         String
  slug           String    @unique
  title          String?
  description    String?
  createdAt      DateTime  @default(now())
  expiresAt      DateTime?
  isPublic       Boolean   @default(true)
  viewCount      Int       @default(0)
  accountNumbers String[]
  dateRange      Json
  desktop        Json      @default("[]")
  mobile         Json      @default("[]")

  @@index([userId])
  @@index([slug])
  @@schema("public")
}

model Tag {
  id          String   @id @default(uuid())
  name        String
  description String?
  color       String?  @default("#CBD5E1")
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
  @@index([userId])
  @@schema("public")
}

model Order {
  id                 String   @id @default(uuid())
  accountId          String
  orderId            String   @unique
  orderAction        String
  quantity           Int
  averageFilledPrice Float
  isOpeningOrder     Boolean
  time               DateTime
  symbol             String
  instrumentType     String
  userId             String
  createdAt          DateTime @default(now())
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([userId])
  @@schema("public")
}

model TradeAnalytics {
  id                 String   @id @default(uuid())
  tradeId            String   @unique
  mae                Float    @default(0)
  mfe                Float    @default(0)
  entryPriceFromData Float?
  priceDifference    Float?
  riskRewardRatio    Float?
  efficiency         Float?
  dataSource         String   @default("DATABENTO")
  computedAt         DateTime @default(now())
  updatedAt          DateTime @updatedAt

  trade              Trade    @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@index([tradeId])
  @@index([computedAt])
  @@schema("public")
}

model HistoricalData {
  id             String   @id @default(uuid())
  symbol         String
  databentSymbol String
  timestamp      DateTime
  open           Float
  high           Float
  low            Float
  close          Float
  volume         Int
  dataSource     String   @default("DATABENTO")
  createdAt      DateTime @default(now())

  @@unique([symbol, databentSymbol, timestamp])
  @@index([symbol])
  @@index([databentSymbol])
  @@index([timestamp])
  @@schema("public")
}

model FilterPreset {
  id          String   @id @default(uuid())
  userId      String
  name        String
  description String?
  filters     Json
  isDefault   Boolean  @default(false)
  isPublic    Boolean  @default(false)
  category    String   @default("custom")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([category])
  @@index([isPublic])
  @@schema("public")
}







enum BreachType {
  daily_drawdown
  max_drawdown

  @@schema("public")
}

enum PhaseAccountStatus {
  active
  passed
  failed
  archived
  pending

  @@schema("public")
}

