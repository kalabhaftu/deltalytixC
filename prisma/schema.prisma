generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["public"]
}

model Account {
  id                     String                   @id
  number                 String
  name                   String?
  broker                 String?
  startingBalance        Float                    @default(0)
  userId                 String
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  isArchived             Boolean                  @default(false)
  User                   User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  DailyNote              DailyNote[]
  LiveAccountTransaction LiveAccountTransaction[]
  Trade                  Trade[]

  @@unique([number, userId])
  @@index([userId])
  @@schema("public")
}

model BacktestTrade {
  id               String            @id
  userId           String
  pair             String
  direction        BacktestDirection
  outcome          BacktestOutcome
  session          BacktestSession
  model            BacktestModel
  customModel      String?
  riskRewardRatio  Float
  entryPrice       Float
  stopLoss         Float
  takeProfit       Float
  exitPrice        Float
  pnl              Float
  imageOne         String?
  imageTwo         String?
  imageThree       String?
  imageFour        String?
  imageFive        String?
  imageSix         String?
  cardPreviewImage String?
  notes            String?
  tags             String[]
  dateExecuted     DateTime
  backtestDate     DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime
  riskPoints       Float             @default(0)
  rewardPoints     Float             @default(0)
  User             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, pair, dateExecuted, entryPrice, direction])
  @@index([userId, model])
  @@schema("public")
}

model BreachRecord {
  id                String       @id
  phaseAccountId    String
  breachType        BreachType
  breachAmount      Float
  breachTime        DateTime     @default(now())
  currentEquity     Float
  accountSize       Float
  dailyStartBalance Float?
  highWaterMark     Float?
  tradeId           String?
  notes             String?
  updatedAt         DateTime     @updatedAt
  PhaseAccount      PhaseAccount @relation(fields: [phaseAccountId], references: [id], onDelete: Cascade)

  @@index([phaseAccountId])
  @@schema("public")
}

model DailyAnchor {
  id             String       @id
  phaseAccountId String
  date           DateTime     @db.Date
  anchorEquity   Float
  computedAt     DateTime     @default(now())
  PhaseAccount   PhaseAccount @relation(fields: [phaseAccountId], references: [id], onDelete: Cascade)

  @@unique([phaseAccountId, date])
  @@index([date])
  @@schema("public")
}

model DailyNote {
  id        String   @id
  userId    String
  date      DateTime @db.Date
  note      String
  createdAt DateTime @default(now())
  updatedAt DateTime
  accountId String?
  emotion   String?
  Account   Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, accountId, date])
  @@index([accountId])
  @@schema("public")
}

model DashboardTemplate {
  id        String   @id
  userId    String
  name      String
  isDefault Boolean  @default(false)
  isActive  Boolean  @default(false)
  layout    Json     @default("[]")
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@index([userId, isActive])
  @@index([userId, isDefault])
  @@schema("public")
}

model LiveAccountTransaction {
  id          String          @id
  accountId   String
  userId      String
  type        TransactionType
  amount      Float
  description String?
  createdAt   DateTime        @default(now())
  Account     Account         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  User        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([accountId, createdAt])
  @@index([userId])
  @@schema("public")
}

model MasterAccount {
  id             String              @id
  userId         String
  accountName    String
  propFirmName   String
  accountSize    Float
  evaluationType String
  currentPhase   Int
  createdAt      DateTime            @default(now())
  status         MasterAccountStatus @default(active)
  isArchived     Boolean             @default(false)
  User           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  Payout         Payout[]
  PhaseAccount   PhaseAccount[]

  @@unique([userId, accountName])
  @@index([userId, status])
  @@schema("public")
}

model Payout {
  id              String        @id
  masterAccountId String
  phaseAccountId  String
  amount          Float
  status          PayoutStatus  @default(pending)
  requestDate     DateTime      @default(now())
  approvedDate    DateTime?
  paidDate        DateTime?
  rejectedDate    DateTime?
  notes           String?
  rejectionReason String?
  updatedAt       DateTime      @updatedAt
  MasterAccount   MasterAccount @relation(fields: [masterAccountId], references: [id], onDelete: Cascade)
  PhaseAccount    PhaseAccount  @relation(fields: [phaseAccountId], references: [id], onDelete: Cascade)

  @@index([masterAccountId])
  @@index([phaseAccountId])
  @@schema("public")
}

model PhaseAccount {
  id                     String             @id
  masterAccountId        String
  phaseNumber            Int
  phaseId                String?
  status                 PhaseAccountStatus @default(active)
  profitTargetPercent    Float
  dailyDrawdownPercent   Float
  maxDrawdownPercent     Float
  maxDrawdownType        DrawdownType       @default(static)
  minTradingDays         Int                @default(0)
  timeLimitDays          Int?
  consistencyRulePercent Float              @default(0)
  profitSplitPercent     Float?
  payoutCycleDays        Int?
  minProfitForPayout     Float?             // Min profit (in $) required to request payout (funded phases only)
  startDate              DateTime           @default(now())
  endDate                DateTime?
  BreachRecord           BreachRecord[]
  DailyAnchor            DailyAnchor[]
  Payout                 Payout[]
  MasterAccount          MasterAccount      @relation(fields: [masterAccountId], references: [id], onDelete: Cascade)
  Trade                  Trade[]

  @@unique([masterAccountId, phaseNumber])
  @@index([masterAccountId])
  @@index([masterAccountId, phaseNumber])
  @@index([masterAccountId, status])
  @@index([phaseId])
  @@index([status])
  @@schema("public")
}

model Trade {
  id                 String        @id
  accountNumber      String
  quantity           Float         @default(0)
  entryId            String?
  instrument         String
  entryPrice         String
  closePrice         String
  entryDate          String
  closeDate          String
  pnl                Float
  timeInPosition     Float         @default(0)
  userId             String
  side               String?
  commission         Float         @default(0)
  createdAt          DateTime      @default(now())
  comment            String?
  groupId            String?
  cardPreviewImage   String?
  imageOne           String?
  imageTwo           String?
  imageThree         String?
  imageFour          String?
  imageFive          String?
  imageSix           String?
  accountId          String?
  phaseAccountId     String?
  symbol             String?
  entryTime          DateTime?
  exitTime           DateTime?
  closeReason        String?
  stopLoss           String?
  takeProfit         String?
  tags               String[]
  marketBias         MarketBias?
  modelId            String?
  selectedRules      Json?
  newsDay            Boolean?      @default(false)
  selectedNews       String?
  newsTraded         Boolean?      @default(false)
  biasTimeframe      String?
  narrativeTimeframe String?
  entryTimeframe     String?
  structureTimeframe String?
  orderType          String?
  chartLinks         String?
  Account            Account?      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  TradingModel       TradingModel? @relation(fields: [modelId], references: [id])
  PhaseAccount       PhaseAccount? @relation(fields: [phaseAccountId], references: [id], onDelete: Cascade)

  @@unique([userId, accountNumber, symbol, entryDate, entryPrice, side, quantity], name: "unique_trade_identification")
  @@index([accountId, exitTime])
  @@index([accountId])
  @@index([accountId, phaseAccountId])
  @@index([accountNumber])
  @@index([entryId])
  @@index([exitTime])
  @@index([groupId])
  @@index([modelId])
  @@index([phaseAccountId, exitTime])
  @@index([phaseAccountId])
  @@index([symbol])
  @@index([userId, accountNumber, id])
  @@index([userId, accountNumber])
  @@index([userId, entryDate(sort: Desc)])
  @@index([userId, entryId])
  @@index([userId])
  @@schema("public")
}

model TradeTag {
  id        String   @id
  name      String
  color     String   @default("#3b82f6")
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
  @@index([userId])
  @@schema("public")
}

model TradingModel {
  id        String   @id
  userId    String
  name      String
  rules     Json     @default("[]")
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Trade     Trade[]

  @@unique([userId, name])
  @@index([userId])
  @@schema("public")
}

model User {
  id                     String                   @id
  email                  String                   @unique
  auth_user_id           String                   @unique
  isFirstConnection      Boolean                  @default(true)
  thorToken              String?
  timezone               String                   @default("UTC")
  theme                  String                   @default("system")
  firstName              String?
  lastName               String?
  accountFilterSettings  String?
  goalSettings           Json?
  backtestInputMode      String                   @default("manual")
  Account                Account[]
  BacktestTrade          BacktestTrade[]
  DailyNote              DailyNote[]
  DashboardTemplate      DashboardTemplate[]
  LiveAccountTransaction LiveAccountTransaction[]
  MasterAccount          MasterAccount[]
  Notification           Notification[]
  TradeTag               TradeTag[]
  TradingModel           TradingModel[]
  WeeklyReview           WeeklyReview[]

  @@index([auth_user_id])
  @@index([email])
  @@schema("public")
}

model Notification {
  id             String           @id @default(uuid())
  userId         String
  type           NotificationType
  title          String
  message        String
  data           Json?
  isRead         Boolean          @default(false)
  actionRequired Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  User           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, actionRequired])
  @@schema("public")
}

model WeeklyReview {
  id            String             @id
  userId        String
  startDate     DateTime           @db.Date
  endDate       DateTime           @db.Date
  calendarImage String?
  expectation   WeeklyExpectation?
  actualOutcome WeeklyExpectation?
  isCorrect     Boolean?
  notes         String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  User          User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, startDate])
  @@index([userId])
  @@schema("public")
}

enum BacktestDirection {
  BUY
  SELL

  @@schema("public")
}

enum BacktestModel {
  ICT_2022
  MSNR
  TTFM
  PRICE_ACTION
  SUPPLY_DEMAND
  SMART_MONEY
  CUSTOM

  @@schema("public")
}

enum BacktestOutcome {
  WIN
  LOSS
  BREAKEVEN

  @@schema("public")
}

enum BacktestSession {
  ASIAN
  LONDON
  NEW_YORK

  @@schema("public")
}

enum BreachType {
  daily_drawdown
  max_drawdown

  @@schema("public")
}

enum DrawdownType {
  static
  trailing

  @@schema("public")
}

enum MarketBias {
  BULLISH
  BEARISH
  UNDECIDED

  @@schema("public")
}

enum MasterAccountStatus {
  active
  funded
  failed

  @@schema("public")
}

enum PayoutStatus {
  pending
  approved
  paid
  rejected

  @@schema("public")
}

enum NotificationType {
  FUNDED_PENDING_APPROVAL
  FUNDED_APPROVED
  FUNDED_DECLINED
  PHASE_TRANSITION_PENDING  // Waiting for user to enter next phase ID
  PAYOUT_APPROVED
  PAYOUT_REJECTED
  SYSTEM

  @@schema("public")
}

enum PhaseAccountStatus {
  active
  passed
  failed
  archived
  pending
  pending_approval

  @@schema("public")
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL

  @@schema("public")
}

enum WeeklyExpectation {
  BULLISH_EXPANSION
  BEARISH_EXPANSION
  CONSOLIDATION

  @@schema("public")
}
